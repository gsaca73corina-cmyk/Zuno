<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ZUNO 3D - EXTREME EDITION by GUNAR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            overflow: hidden;
            background: radial-gradient(circle, #0d1421, #000000);
            font-family: 'Orbitron', monospace;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #creator-signature {
            position: absolute;
            bottom: 15px;
            right: 20px;
            z-index: 999;
            color: #00ffea;
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 0 15px #00ffea;
            letter-spacing: 3px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: rgba(13, 20, 33, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #gameTitle {
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ff0080, #00ffea, #ff4081, #00ff80);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 2s ease-in-out infinite;
            margin-bottom: 20px;
            letter-spacing: 5px;
        }

        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #subtitle {
            font-size: 1.5rem;
            color: #00ffea;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(0, 255, 234, 0.5);
        }

        #mobileInstructions {
            font-size: 1rem;
            color: #00ff80;
            margin-bottom: 30px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
        }

        #startBtn {
            padding: 25px 60px;
            font-size: 1.8rem;
            font-weight: 900;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            background: linear-gradient(45deg, #ff0080, #ff4081);
            color: white;
            border: 3px solid transparent;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 0, 128, 0.8);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 4px;
            position: relative;
        }

        #startBtn:hover, #startBtn:active {
            background: linear-gradient(45deg, #ff4081, #00ffea);
            box-shadow: 0 0 60px rgba(0, 255, 234, 1);
            transform: scale(1.05);
        }

        #funnyQuote {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1500;
            color: #00ff80;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            max-width: 80%;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 25px;
            border: 2px solid #00ff80;
            box-shadow: 0 0 25px rgba(0, 255, 128, 0.5);
            backdrop-filter: blur(10px);
        }

        /* Zonas táctiles invisibles para móvil */
        #touchZones {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1500;
            pointer-events: none;
        }

        #touchZones.active {
            pointer-events: auto;
        }

        .touch-zone {
            position: absolute;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .touch-zone.active {
            background: rgba(0, 255, 234, 0.08);
            border-color: rgba(0, 255, 234, 0.2);
        }

        #leftZone {
            left: 0;
            top: 20%;
            width: 30%;
            height: 60%;
        }

        #rightZone {
            right: 0;
            top: 20%;
            width: 30%;
            height: 60%;
        }

        #jumpZone {
            left: 30%;
            top: 0;
            width: 40%;
            height: 100%;
        }

        /* Indicadores visuales para móvil */
        #mobileHints {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1400;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #mobileHints.show {
            opacity: 1;
        }

        .hint {
            position: absolute;
            color: #00ffea;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 0 10px #00ffea;
            animation: hintPulse 2s infinite;
        }

        @keyframes hintPulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        #leftHint {
            left: 15%;
            top: 50%;
            transform: translateY(-50%);
        }

        #rightHint {
            right: 15%;
            top: 50%;
            transform: translateY(-50%);
        }

        #jumpHint {
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
        }

        #hud {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 1000;
            background: rgba(13, 20, 33, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ffea;
            border-radius: 15px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 0 30px rgba(0, 255, 234, 0.3);
        }

        .hud-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: white;
            font-size: 16px;
            font-weight: 700;
        }

        .hud-value {
            color: #00ffea;
            text-shadow: 0 0 10px #00ffea;
        }

        #score {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 1000;
            background: linear-gradient(45deg, #ff0080, #ff4081);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: 900;
            box-shadow: 0 0 30px rgba(255, 0, 128, 0.6);
        }

        /* Historial de puntuaciones */
        #scoreHistory {
            position: absolute;
            bottom: 80px;
            right: 15px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #00ffea;
            border-radius: 10px;
            padding: 10px;
            min-width: 150px;
            max-width: 200px;
        }

        #scoreHistory h4 {
            color: #00ffea;
            font-size: 12px;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 0 0 5px #00ffea;
        }

        .score-entry {
            display: flex;
            justify-content: space-between;
            color: #fff;
            font-size: 10px;
            margin: 3px 0;
            padding: 2px 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
        }

        .score-entry.new {
            background: rgba(0, 255, 234, 0.2);
            animation: newScore 1s ease-out;
        }

        @keyframes newScore {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        #musicIndicator {
            position: absolute;
            bottom: 60px;
            left: 25px;
            z-index: 1000;
            color: #00ff80;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #00ff80;
            backdrop-filter: blur(5px);
        }

        #gameOverScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2500;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 3px solid #ff0080;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 0, 128, 0.6);
            min-width: 400px;
            max-width: 90%;
        }

        #gameOverScreen h2 {
            font-size: 3rem;
            color: #ff0080;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff0080;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 16px;
            color: white;
        }

        .stat-value {
            color: #00ffea;
            font-weight: bold;
        }

        #restartBtn {
            margin-top: 25px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            background: linear-gradient(45deg, #00ff80, #00ffea);
            color: #000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        #restartBtn:hover, #restartBtn:active {
            background: linear-gradient(45deg, #00ffea, #00ff80);
            transform: scale(1.05);
        }

        .hidden { display: none !important; }

        /* Responsivo para móvil */
        @media (max-width: 768px) {
            #gameTitle {
                font-size: 3.5rem;
            }
            
            #subtitle {
                font-size: 1.2rem;
            }
            
            #startBtn {
                padding: 20px 40px;
                font-size: 1.4rem;
            }
            
            #hud {
                top: 15px;
                left: 15px;
                padding: 15px;
                min-width: 200px;
            }
            
            .hud-item {
                font-size: 14px;
            }
            
            #score {
                top: 15px;
                right: 15px;
                padding: 15px 20px;
                font-size: 18px;
            }
            
            #gameOverScreen {
                min-width: 320px;
                padding: 30px 20px;
            }
            
            #gameOverScreen h2 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="startScreen">
            <h1 id="gameTitle">ZUNO 3D</h1>
            <p id="subtitle">GUNAR EDITION</p>
            <p id="mobileInstructions">
                📱 MÓVIL: Toca izquierda/derecha para moverte<br>
                Toca el centro o desliza hacia arriba para saltar<br>
                💻 PC: Flechas/WASD + Espacio
            </p>
            <button id="startBtn">🚀 INICIAR MISIÓN</button>
        </div>

        <div id="creator-signature">💎 HECHO POR GUNAR 💎</div>

        <div id="funnyQuote" class="hidden"></div>

        <!-- Zonas táctiles invisibles -->
        <div id="touchZones">
            <div id="leftZone" class="touch-zone"></div>
            <div id="jumpZone" class="touch-zone"></div>
            <div id="rightZone" class="touch-zone"></div>
        </div>

        <!-- Indicadores visuales para móvil -->
        <div id="mobileHints">
            <div id="leftHint" class="hint">← IZQUIERDA</div>
            <div id="jumpHint" class="hint">↑ SALTO / TAP</div>
            <div id="rightHint" class="hint">DERECHA →</div>
        </div>

        <div id="hud" class="hidden">
            <div class="hud-item">
                <span>⏱️ TIEMPO:</span>
                <span class="hud-value" id="hudTime">0s</span>
            </div>
            <div class="hud-item">
                <span>❤️ VIDAS:</span>
                <span class="hud-value" id="hudLives">3</span>
            </div>
            <div class="hud-item">
                <span>⚡ VELOCIDAD:</span>
                <span class="hud-value" id="hudSpeed">1.0x</span>
            </div>
            <div class="hud-item">
                <span>💥 NIVEL:</span>
                <span class="hud-value" id="hudDifficulty">NORMAL</span>
            </div>
        </div>

        <div id="score" class="hidden">
            <span>🏆 </span><span id="scoreValue">0</span><span> PTS</span>
        </div>

        <!-- Historial de puntuaciones -->
        <div id="scoreHistory" class="hidden">
            <h4>📊 TOP 5</h4>
            <div id="scoreList"></div>
        </div>

        <div id="musicIndicator" class="hidden">
            <span>🎵 </span><span id="currentTrack">Track 1</span>
        </div>

        <div id="gameOverScreen" class="hidden">
            <h2>💀 MISIÓN FALLIDA</h2>
            <div class="stat-item">
                <span>⏱️ Tiempo:</span>
                <span class="stat-value" id="finalTime">0s</span>
            </div>
            <div class="stat-item">
                <span>🏆 Puntos:</span>
                <span class="stat-value" id="finalScore">0</span>
            </div>
            <div class="stat-item">
                <span>💥 Obstáculos:</span>
                <span class="stat-value" id="finalObstacles">0</span>
            </div>
            <div class="stat-item">
                <span>🎵 Track:</span>
                <span class="stat-value" id="finalTrack">-</span>
            </div>
            <button id="restartBtn">🔄 NUEVA MISIÓN</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ZUNO 3D EXTREME BY GUNAR - VERSIÓN MEJORADA
        let scene, camera, renderer, player, tunnel, canvas;
        let obstacles = [], gameRunning = false;
        let obstacleSpeed = 0.5, baseSpeed = 0.5, spawnInterval = 0, lastSpawn = 0;
        let lives = 3, startTime = 0, elapsedTime = 0, score = 0, obstaclesAvoided = 0;
        let currentTrack = 1, currentQuoteIndex = 0, difficultyLevel = 1;
        let isMobile = false, showMobileHints = false;
        const keys = {};

        // Sistema de puntuaciones
        let scoreHistory = [];
        try {
            scoreHistory = JSON.parse(localStorage.getItem('zunoScores') || '[]');
        } catch (e) {
            scoreHistory = [];
        }

        // FRASES EXISTENCIALES Y GRACIOSAS
        const funnyQuotes = [
            "🌌 GUNAR: Eres polvo de estrellas… pero ni brillando te ubicas.",
            "⏳ GUNAR: El tiempo vuela, menos tus reflejos.",
            "🌀 GUNAR: El universo se expande… como tus excusas.",
            "🔥 GUNAR: La vida es un instante… y ya fallaste en este.",
            "🌙 GUNAR: ¿De qué sirve soñar si ni despierto reaccionas?",
            "⚖️ GUNAR: Entre el ser y no ser… tú elegiste buggear.",
            "🧩 GUNAR: La existencia es un rompecabezas… al que le faltas piezas.",
            "🪐 GUNAR: Somos minúsculos en el cosmos… y tú aún más.",
            "🎭 GUNAR: El absurdo de la vida es real… igual que tu puntería absurda.",
            "🔮 GUNAR: El destino existe… pero ni él te quiere en su plan.",
            "🤖 GUNAR: Los robots no lloran… pero tú me das ganas.",
            "🎯 GUNAR: Tu precisión es tan real como Santa Claus.",
            "🚀 GUNAR: Más perdido que satélite sin órbita.",
            "💎 GUNAR: Eres único… como un error 404.",
            "🎮 GUNAR: Practica más… o empieza a rezar.",
            "🌟 GUNAR: Brillas… como foco quemado.",
            "🎪 GUNAR: Bienvenido al circo de tus decisiones.",
            "⚡ GUNAR: Tu velocidad de reacción es patrocinada por Windows XP.",
            "🎲 GUNAR: Jugando con el destino… siempre en modo principiante.",
            "💥 GUNAR: Más explosivo que tus fracasos en cadena."
        ];

        // ELEMENTOS DOM
        const els = {
            startScreen: document.getElementById("startScreen"),
            startBtn: document.getElementById("startBtn"),
            hud: document.getElementById("hud"),
            hudTime: document.getElementById("hudTime"),
            hudLives: document.getElementById("hudLives"),
            hudSpeed: document.getElementById("hudSpeed"),
            hudDifficulty: document.getElementById("hudDifficulty"),
            scoreValue: document.getElementById("scoreValue"),
            scoreDiv: document.getElementById("score"),
            scoreHistory: document.getElementById("scoreHistory"),
            scoreList: document.getElementById("scoreList"),
            funnyQuote: document.getElementById("funnyQuote"),
            musicIndicator: document.getElementById("musicIndicator"),
            currentTrack: document.getElementById("currentTrack"),
            gameOverScreen: document.getElementById("gameOverScreen"),
            finalTime: document.getElementById("finalTime"),
            finalScore: document.getElementById("finalScore"),
            finalObstacles: document.getElementById("finalObstacles"),
            finalTrack: document.getElementById("finalTrack"),
            restartBtn: document.getElementById("restartBtn"),
            touchZones: document.getElementById("touchZones"),
            mobileHints: document.getElementById("mobileHints"),
            leftZone: document.getElementById("leftZone"),
            jumpZone: document.getElementById("jumpZone"),
            rightZone: document.getElementById("rightZone")
        };

        // Detectar si es móvil
        function detectMobile() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase()) || 
                      ('ontouchstart' in window) || 
                      (window.innerWidth <= 768);
            
            if (isMobile) {
                document.body.classList.add('mobile');
                showMobileHints = true;
            }
        }

        function init() {
            console.log("🚀 Inicializando ZUNO 3D by GUNAR");
            
            detectMobile();
            loadScoreHistory();
            
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x0d1421, 10, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 6);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x0d1421);
            renderer.shadowMap.enabled = true;
            
            document.getElementById('game-container').insertBefore(renderer.domElement, els.startScreen);
            canvas = renderer.domElement;
            canvas.style.touchAction = "none";

            createScene();
            setupEvents();
            showQuote();
            animate();
        }

        function createScene() {
            // LUCES
            const mainLight = new THREE.DirectionalLight(0xffffff, 2);
            mainLight.position.set(0, 10, 10);
            mainLight.castShadow = true;
            scene.add(mainLight);

            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            const neon1 = new THREE.PointLight(0x00ffea, 3, 30);
            neon1.position.set(-4, 0, 0);
            scene.add(neon1);

            const neon2 = new THREE.PointLight(0xff0080, 3, 30);
            neon2.position.set(4, 0, 0);
            scene.add(neon2);

            // JUGADOR
            const playerGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const playerMat = new THREE.MeshPhongMaterial({ 
                color: 0x00ffea,
                shininess: 200,
                emissive: 0x002244
            });
            
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.set(0, -1.5, 0);
            player.castShadow = true;
            player.userData = { dy: 0, onGround: true, moveSpeed: 0.15 };
            scene.add(player);

            // TÚNEL
            const tunnelGeo = new THREE.CylinderGeometry(7, 7, 300, 32, 1, true);
            const tunnelMat = new THREE.MeshPhongMaterial({
                color: 0x1a1a2e,
                side: THREE.BackSide,
                wireframe: true,
                transparent: true,
                opacity: 0.7
            });
            
            tunnel = new THREE.Mesh(tunnelGeo, tunnelMat);
            tunnel.rotation.z = Math.PI / 2;
            tunnel.position.z = -145;
            scene.add(tunnel);

            // PARTÍCULAS
            const particleGeo = new THREE.BufferGeometry();
            const positions = [], colors = [];

            for (let i = 0; i < 200; i++) {
                positions.push(
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 100,
                    (Math.random() - 0.5) * 200
                );
                
                const color = new THREE.Color();
                color.setHSL(Math.random() * 0.3 + 0.7, 0.8, 0.6);
                colors.push(color.r, color.g, color.b);
            }

            particleGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            particleGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const particleMat = new THREE.PointsMaterial({
                size: 3,
                vertexColors: true,
                transparent: true,
                opacity: 0.8
            });

            const particles = new THREE.Points(particleGeo, particleMat);
            scene.add(particles);
        }

        function showQuote() {
            const quote = funnyQuotes[Math.floor(Math.random() * funnyQuotes.length)];
            els.funnyQuote.textContent = quote;
            els.funnyQuote.classList.remove('hidden');
            
            setTimeout(() => {
                if (!gameRunning) showQuote();
            }, 4000);
        }

        // Sistema de puntuaciones
        function loadScoreHistory() {
            updateScoreDisplay();
        }

        function saveScore(newScore, time, obstacles) {
            const scoreEntry = {
                score: newScore,
                time: time,
                obstacles: obstacles,
                date: new Date().toLocaleDateString()
            };
            
            scoreHistory.unshift(scoreEntry);
            scoreHistory = scoreHistory.slice(0, 5); // Mantener solo top 5
            
            try {
                localStorage.setItem('zunoScores', JSON.stringify(scoreHistory));
            } catch (e) {
                console.log('No se pudo guardar el puntaje');
            }
            updateScoreDisplay(true);
        }

        function updateScoreDisplay(isNew = false) {
            els.scoreList.innerHTML = '';
            
            scoreHistory.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = `score-entry ${isNew && index === 0 ? 'new' : ''}`;
                div.innerHTML = `
                    <span>#${index + 1}</span>
                    <span>${entry.score}pts</span>
                `;
                els.scoreList.appendChild(div);
            });
        }

        // REPRODUCCIÓN DE MÚSICA
        let audioPlayer = new Audio();
        audioPlayer.loop = false;
        audioPlayer.addEventListener('ended', () => {
            playNewTrack();
        });

        let lastTrack = 0;

        function playNewTrack() {
            let newTrack;
            do {
                newTrack = Math.floor(Math.random() * 100) + 1;
            } while (newTrack === lastTrack);

            lastTrack = newTrack;
            const trackPath = `assets/music/track${newTrack}.mp3`;

            audioPlayer.src = trackPath;
            audioPlayer.play().catch(e => console.log("🎵 Error al reproducir:", e));

            els.currentTrack.textContent = `Track ${newTrack}`;
            els.finalTrack.textContent = `Track ${newTrack}`;
        }

        function spawnObstacle() {
            const types = ['cube', 'spike', 'wall', 'spinner'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let geometry;
            switch(type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    break;
                case 'spike':
                    geometry = new THREE.ConeGeometry(0.6, 2, 8);
                    break;
                case 'wall':
                    geometry = new THREE.BoxGeometry(6, 3, 0.5);
                    break;
                case 'spinner':
                    geometry = new THREE.OctahedronGeometry(1);
                    break;
            }
            
            const material = new THREE.MeshPhongMaterial({
                color: 0xff0055,
                shininess: 100,
                emissive: 0x220011
            });
            
            const obstacle = new THREE.Mesh(geometry, material);
            
            if (type === 'wall') {
                obstacle.position.set(0, -1.5, -50);
                // Crear agujero
                const hole = new THREE.Mesh(
                    new THREE.BoxGeometry(1.5, 1.5, 1),
                    new THREE.MeshBasicMaterial({ transparent: true, opacity: 0 })
                );
                hole.position.set(
                    (Math.random() - 0.5) * 3,
                    (Math.random() - 0.5) * 2,
                    0
                );
                obstacle.add(hole);
            } else {
                obstacle.position.set(
                    (Math.random() - 0.5) * 8,
                    -1.5 + Math.random() * 3,
                    -50
                );
            }
            
            obstacle.castShadow = true;
            obstacle.userData = { 
                rotSpeed: (Math.random() - 0.5) * 0.1,
                type: type
            };
            
            scene.add(obstacle);
            obstacles.push(obstacle);
        }

        function updateGame() {
            if (!gameRunning) return;

            elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            
            // Actualizar dificultad
            difficultyLevel = Math.floor(elapsedTime / 10) + 1;
            obstacleSpeed = baseSpeed * (1 + elapsedTime * 0.03);
            spawnInterval = Math.max(200, 300 - elapsedTime * 5);
            
            // Movimiento del jugador
            const speed = player.userData.moveSpeed;
            if (keys["ArrowLeft"] || keys["a"] || keys["A"]) {
                player.position.x = Math.max(player.position.x - speed, -5);
            }
            if (keys["ArrowRight"] || keys["d"] || keys["D"]) {
                player.position.x = Math.min(player.position.x + speed, 5);
            }
            if (keys["ArrowUp"] || keys["w"] || keys["W"]) {
                player.position.z = Math.max(player.position.z - speed, -2);
            }
            if (keys["ArrowDown"] || keys["s"] || keys["S"]) {
                player.position.z = Math.min(player.position.z + speed, 2);
            }

            // Física de salto
            player.position.y += player.userData.dy;
            player.userData.dy -= 0.015;

            if (player.position.y <= -1.5) {
                player.position.y = -1.5;
                player.userData.dy = 0;
                player.userData.onGround = true;
            }

            // Generar obstáculos
            const now = Date.now();
            if (now - lastSpawn > spawnInterval) {
                spawnObstacle();
                lastSpawn = now;
            }

            // Actualizar obstáculos
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.position.z += obstacleSpeed;
                
                obs.rotation.x += obs.userData.rotSpeed;
                obs.rotation.y += obs.userData.rotSpeed * 0.7;

                // Colisión
                if (player.position.distanceTo(obs.position) < 0.8) {
                    takeDamage();
                    removeObstacle(i);
                    continue;
                }

                // Remover obstáculos pasados
                if (obs.position.z > 10) {
                    score += 10;
                    obstaclesAvoided++;
                    removeObstacle(i);
                }
            }

            // Actualizar UI
            updateHUD();
            
            // Animación del túnel
            tunnel.rotation.x += 0.005;
            tunnel.position.z += 0.1;
            if (tunnel.position.z > 100) {
                tunnel.position.z = -145;
            }

            // Cambiar música cada 30 segundos
            if (elapsedTime > 0 && elapsedTime % 30 === 0 && Date.now() - startTime > elapsedTime * 1000 - 100) {
                playNewTrack();
            }

            // Mostrar frases ocasionalmente
            if (elapsedTime > 0 && elapsedTime % 15 === 0 && Date.now() - startTime > elapsedTime * 1000 - 100) {
                showGameQuote();
            }
        }

        function showGameQuote() {
            if (!gameRunning) return;
            const quote = funnyQuotes[Math.floor(Math.random() * funnyQuotes.length)];
            els.funnyQuote.textContent = quote;
            els.funnyQuote.classList.remove('hidden');
            setTimeout(() => {
                els.funnyQuote.classList.add('hidden');
            }, 5000);
        }

        function removeObstacle(index) {
            scene.remove(obstacles[index]);
            obstacles.splice(index, 1);
        }

        function takeDamage() {
            lives--;
            player.material.color.setHex(0xff0000);
            setTimeout(() => {
                if (player.material) player.material.color.setHex(0x00ffea);
            }, 200);

            if (lives <= 0) {
                endGame();
            }
        }

        function updateHUD() {
            els.hudTime.textContent = `${elapsedTime}s`;
            els.hudLives.textContent = lives;
            els.hudSpeed.textContent = `${(obstacleSpeed / baseSpeed).toFixed(1)}x`;
            els.hudDifficulty.textContent = difficultyLevel < 1 ? 'NORMAL' : 
                                          difficultyLevel < 2 ? 'DIFÍCIL' : 
                                          difficultyLevel < 5 ? 'EXTREMO' : 'IMPOSIBLE';
            els.scoreValue.textContent = score;
        }

        function startGame() {
            console.log("🎮 Iniciando misión");
            
            gameRunning = true;
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            
            obstacleSpeed = baseSpeed;
            lives = 3;
            score = 0;
            obstaclesAvoided = 0;
            elapsedTime = 0;
            difficultyLevel = 1;
            startTime = Date.now();
            lastSpawn = Date.now();

            player.position.set(0, -1.5, 0);
            player.userData.dy = 0;
            player.userData.onGround = true;

            els.startScreen.classList.add('hidden');
            els.hud.classList.remove('hidden');
            els.scoreDiv.classList.remove('hidden');
            els.scoreHistory.classList.remove('hidden');
            els.musicIndicator.classList.remove('hidden');
            els.funnyQuote.classList.add('hidden');

            // Activar zonas táctiles en móvil
            if (isMobile) {
                els.touchZones.classList.add('active');
                if (showMobileHints) {
                    els.mobileHints.classList.add('show');
                    setTimeout(() => {
                        els.mobileHints.classList.remove('show');
                    }, 5000);
                }
            }

            playNewTrack();
            updateHUD();
        }

        function endGame() {
            console.log("💀 Misión fallida");
            
            gameRunning = false;
            
            els.touchZones.classList.remove('active');
            els.mobileHints.classList.remove('show');
            
            els.finalTime.textContent = `${elapsedTime}s`;
            els.finalScore.textContent = score;
            els.finalObstacles.textContent = obstaclesAvoided;
            els.gameOverScreen.classList.remove('hidden');

            // Guardar puntuación
            saveScore(score, elapsedTime, obstaclesAvoided);
        }

        function resetGame() {
            els.startScreen.classList.remove('hidden');
            els.hud.classList.add('hidden');
            els.scoreDiv.classList.add('hidden');
            els.scoreHistory.classList.add('hidden');
            els.musicIndicator.classList.add('hidden');
            els.gameOverScreen.classList.add('hidden');
            els.touchZones.classList.remove('active');
            els.mobileHints.classList.remove('show');
            showQuote();
        }

        function jump() {
            if (player.userData.onGround) {
                player.userData.dy = 0.25;
                player.userData.onGround = false;
            }
        }

        function setupEvents() {
            // --- Teclado ---
            window.addEventListener("keydown", (e) => {
                keys[e.key] = true;

                if (e.code === "Space" || e.code === "Enter") {
                    e.preventDefault();
                    if (!gameRunning) {
                        startGame();
                    } else {
                        jump();
                    }
                }

                if (e.code === "Escape" && gameRunning) {
                    endGame();
                }
            });

            window.addEventListener("keyup", (e) => {
                keys[e.key] = false;
            });

            // --- Botones ---
            els.startBtn.addEventListener("click", (e) => {
                e.preventDefault();
                startGame();
            });

            els.startBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                startGame();
            });

            els.restartBtn.addEventListener("click", (e) => {
                e.preventDefault();
                resetGame();
            });

            els.restartBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                resetGame();
            });

            // --- Redimensionar ---
            window.addEventListener("resize", () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // --- Controles táctiles mejorados ---
            let touchState = {};
            let activeZones = new Set();

            function onPointerDown(e) {
                if (!gameRunning) return;
                
                const id = e.pointerId ?? "mouse";
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const w = rect.width;
                const h = rect.height;

                touchState[id] = {
                    startX: x,
                    startY: y,
                    startTime: Date.now(),
                    zone: null
                };

                // Determinar zona
                if (x < w * 0.3) {
                    touchState[id].zone = 'left';
                    keys["ArrowLeft"] = true;
                    keys["ArrowRight"] = false;
                    activeZones.add('left');
                    els.leftZone.classList.add('active');
                } else if (x > w * 0.7) {
                    touchState[id].zone = 'right';
                    keys["ArrowRight"] = true;
                    keys["ArrowLeft"] = false;
                    activeZones.add('right');
                    els.rightZone.classList.add('active');
                } else {
                    touchState[id].zone = 'jump';
                    jump();
                    els.jumpZone.classList.add('active');
                    setTimeout(() => {
                        els.jumpZone.classList.remove('active');
                    }, 200);
                }

                e.preventDefault();
            }

            function onPointerMove(e) {
                if (!gameRunning) return;
                
                const id = e.pointerId ?? "mouse";
                const state = touchState[id];
                if (!state) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const dy = y - state.startY;

                // Swipe hacia arriba para salto adicional
                if (dy < -50 && state.zone !== 'jump') {
                    jump();
                    state.startY = y; // Reset para evitar saltos múltiples
                }

                e.preventDefault();
            }

            function onPointerUp(e) {
                const id = e.pointerId ?? "mouse";
                const state = touchState[id];
                if (!state) return;

                // Limpiar teclas y zonas activas
                if (state.zone === 'left') {
                    keys["ArrowLeft"] = false;
                    activeZones.delete('left');
                    els.leftZone.classList.remove('active');
                } else if (state.zone === 'right') {
                    keys["ArrowRight"] = false;
                    activeZones.delete('right');
                    els.rightZone.classList.remove('active');
                }

                delete touchState[id];
                e.preventDefault();
            }

            function onPointerCancel(e) {
                const id = e.pointerId ?? "mouse";
                delete touchState[id];
                keys["ArrowLeft"] = false;
                keys["ArrowRight"] = false;
                activeZones.clear();
                els.leftZone.classList.remove('active');
                els.rightZone.classList.remove('active');
            }

            // Aplicar eventos táctiles solo en móvil
            if (isMobile && canvas) {
                canvas.addEventListener("pointerdown", onPointerDown, { passive: false });
                canvas.addEventListener("pointermove", onPointerMove, { passive: false });
                canvas.addEventListener("pointerup", onPointerUp, { passive: false });
                canvas.addEventListener("pointercancel", onPointerCancel, { passive: false });
                canvas.addEventListener("contextmenu", (e) => e.preventDefault());

                // Prevenir zoom y scroll
                document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                document.addEventListener('gesturestart', (e) => e.preventDefault());
                document.addEventListener('gesturechange', (e) => e.preventDefault());
                document.addEventListener('gestureend', (e) => e.preventDefault());
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            updateGame();
            renderer.render(scene, camera);
        }

        // INICIALIZAR cuando se cargue la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>